// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/rust
{
  "name": "Rust",
  "image": "mcr.microsoft.com/devcontainers/rust:2-1-bookworm",

  // Persist cargo + target + tmp across container rebuilds.
  // NOTE: Docker volumes often mount as root-owned; we fix permissions below.
  "mounts": [
    { "source": "felix-cargo",  "target": "/usr/local/cargo",        "type": "volume" },
    { "source": "felix-target", "target": "/workspaces/.cargo-target","type": "volume" },
    { "source": "felix-tmp",    "target": "/workspaces/.tmp",        "type": "volume" }
  ],

  "features": {
    "ghcr.io/audacioustux/devcontainers/taskfile:1": {},
    "ghcr.io/devcontainers/features/docker-outside-of-docker:1": {}
  },

  "remoteEnv": {
    "DOCKER_HOST": "unix:///var/run/docker.sock",

    // Make builds deterministic and avoid filling /tmp inside the container layer.
    "CARGO_TARGET_DIR": "/workspaces/.cargo-target",

    // Keep temp off /tmp (which can be small / tmpfs depending on runtime),
    // but ensure it is writable via chown in postCreate/postStart.
    "TMPDIR": "/workspaces/.tmp"
  },

  "runArgs": [
    "--cap-add=SYS_PTRACE",
    "--security-opt=seccomp=unconfined",
    "-v",
    "/var/run/docker.sock:/var/run/docker.sock"
  ],

  // Fix permissions on mounted volumes before running any setup that may invoke rustup/cargo.
  // Do NOT remove these chowns unless you also remove the volume mounts.
  "postCreateCommand": "bash -lc 'set -euo pipefail; sudo mkdir -p /usr/local/cargo /workspaces/.cargo-target /workspaces/.tmp; sudo chown -R vscode:vscode /usr/local/cargo /workspaces/.cargo-target /workspaces/.tmp; sudo chmod -R u+rwX /usr/local/cargo /workspaces/.cargo-target /workspaces/.tmp; bash scripts/devcontainer-setup.sh'",

  // Also enforce on every start (rebuilds, restarts, attach) so you never regress.
  "postStartCommand": "bash -lc 'set -euo pipefail; sudo mkdir -p /usr/local/cargo /workspaces/.cargo-target /workspaces/.tmp; sudo chown -R vscode:vscode /usr/local/cargo /workspaces/.cargo-target /workspaces/.tmp; sudo chmod -R u+rwX /usr/local/cargo /workspaces/.cargo-target /workspaces/.tmp'"
}